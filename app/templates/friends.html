<!DOCTYPE html>
<html>

<head>
  {% include 'header.html' %}
  <style>
    .friends {
      margin-left: 0;
      list-style: none;
    }

    .message-block {
      display: flex;
      align-items: top;
      position: relative;
      height: auto;
      width: 100%;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .message-block.left {
      justify-content: left;

    }

    .message-block.right {
      justify-content: right;
    }

    .message-avatar {
      display: block;
      width: 40px;
      height: 40px;
    }

    .message-text {
      display: flex;
      margin-bottom: 10px;
    }

    .message-block.left .message-text {
      text-align: left;
      margin-right: 60px;
    }

    .message-block.right .message-text {
      text-align: right;
      margin-left: 60px;
    }

    .message-block.left .message-text::before {
      width: 5px;
      height: 5px;
      border-top: 15px solid #5ac9e8;
      border-left: 15px solid transparent;
      margin-top: 10px;
      margin-left: 5px;
      content: " ";
    }

    .message-block.message-block.right .message-text::after {
      width: 5px;
      height: 5px;
      border-top: 15px solid #5ac9e8;
      border-right: 15px solid transparent;
      margin-top: 10px;
      margin-right: 5px;
      content: " ";
    }

    .message-span {
      display: inline-block;
      background-color: #5ac9e8;
      border-radius: 10px;
      padding: 10px;
      color: #ffffff;
    }

    a.button:hover {
      color: #ffffff;
    }
  </style>
</head>

<body>
  {% include 'nav.html' %}
  <section class="section">
    <div id="app" class="columns">
      <div class="column is-one-quarter" style="position: relative; min-height: 30rem;">
        <div class="panel" style="height: 100%;">
          <p class="panel-heading align-center is-capoo">
            {{ friend_list }}
          </p>
          <p class="control has-icons-left has-icons-right" style="margin-bottom: 1px;">
            <input class="input" v-model="input_name" style="border-radius: 0; box-shadow: none;" type="text" placeholder="添加好友">
            <span class="icon is-left">
              <i class="fas fa-search" aria-hidden="true"></i>
            </span>
            <span class="icon is-right" v-on:click="add_friend" style="pointer-events: auto;">
              <i class="fas fa-arrow-right"></i>
            </span>
          </p>
          {% raw %}
          <p class="notification is-light" v-bind:class="{'is-danger': message_is_error, 'is-success': !message_is_error}" style="padding: 0.5rem 1rem;">
            {{ add_friend_message }}
          </p>
          {% endraw %}

          <div class="panel-block normal-color"
            style="display: block; position: absolute; top: 106.5px; bottom: 69px; left: 12px; right: 12px; overflow-y: scroll;"
            v-bind:style="{'margin-top': (add_friend_message.length ? '2.5rem' : '0')}">
            <aside class="menu">
              <p class="menu-label">
                {{ gaming }}
              </p>
              <ul class="menu-list friends">
                {% raw %}
                <li v-for="friend of gaming_friends"><a>{{ friend.name }}</a></li>
                {% endraw %}
              </ul>
              <p class="menu-label">
                {{ waiting }}
              </p>
              <ul class="menu-list friends">
                {% raw %}
                <li v-for="friend of waiting_friends"><a>{{ friend.name }}</a></li>
                {% endraw %}
              </ul>
              <p class="menu-label">
                {{ offline }}
              </p>
              <ul class="menu-list friends">
                {% raw %}
                <li v-for="friend of offline_friends"><a>{{ friend.name }}</a></li>
                {% endraw %}
              </ul>
            </aside>
          </div>

          <div class="panel-block normal-color"
            style="position: absolute; height: 58px; left: 12px; right: 12px; bottom: 12px;">
            <a href="#" class="card-footer-item is-capoo-2">{{ join_game }}</a>
            <a href="#" class="card-footer-item is-capoo-2">{{ delete_friend }}</a>
          </div>

        </div>

      </div>
      <div class="column" style="position: relative; min-height: 60rem;">
        <div class="panel" style="height: 100%;">
          {% raw %}
          <p class="panel-heading align-center is-capoo">{{ left_username }}</p>

          <ul class="panel-block normal-color"
            style="display: block; position: absolute; top: 66px; bottom: 69px; left: 12px; right: 12px; overflow-y: scroll;">
            <div v-for="msg of messages">

              <li v-if="msg.mine" class="message-block right">
                <p class="message-text">
                  <span class="message-span">{{ msg.content }}</span>
                </p>
                <img :src="right_avatar" class="message-avatar">
              </li>

              <li v-else class="message-block left">
                <img :src="left_avatar" class="message-avatar">
                <p class="message-text">
                  <span class="message-span">{{ msg.content }}</span>
                </p>
              </li>

            </div>

          </ul>
          {% endraw %}
          <div class="panel-block normal-color" style="position: absolute; left: 12px; right: 12px; bottom: 12px;">
            <input class="input" type="text">
            <a class="button is-capoo" style="margin-left: 10px;">{{ send }}</a>
          </div>

        </div>
      </div>
    </div>
  </section>
  <script>
    new Vue({
      el: '#app',
      data: {
        left_username: '先辈',
        left_avatar: '/static/avatar.png',

        right_username: 'capoo',
        right_avatar: '/static/favicon.png',

        friends: [],
        gaming_friends: [],
        waiting_friends: [],
        offline_friends: [],

        input_name: '',

        add_friend_message: '',
        message_is_error: false,

        messages: [
          {
            mine: false,
            content: '哼哼',
          },
          {
            mine: false,
            content: 'aaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa aaaaaaaaaaaa aaaaaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaa',
          },
          {
            mine: true,
            content: 'aaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa aaaaaaaaaaaa aaaaaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
          {
            mine: true,
            content: 'aaa',
          },
        ]
      },
      mounted: function () {
        this.update_friends_list();
      },
      methods: {
        update_friends_list: function () {
          this.$http.get('/api/account/get_friends').then(function (ret) {
            console.log(ret.body);
            if (ret.body.code == 0) {
              console.log(ret.body.friends);
              this.friends = ret.body.friends;
              var gaming_friends = [];
              var waiting_friends = [];
              var offline_friends = [];
              for (const i of this.friends) {
                console.log(i);
                console.log(i.name + ' ' + i.status);
                if (i.status == 'gaming') {
                  gaming_friends.push(i);
                } else if (i.status == 'waiting') {
                  waiting_friends.push(i);
                } else if (i.status == 'offline') {
                  offline_friends.push(i);
                } else {
                  console.log('Unknown status ' + i.status + ' of friend ' + i.name);
                }
              }
              this.gaming_friends = gaming_friends;
              this.waiting_friends = waiting_friends;
              this.offline_friends = offline_friends;
            } else {
              console.log('There is not logined user.');
            }
          }, function (ret) {
            console.log('Request fails, status:', ret);
          });
        },
        add_friend: function () {
          if (!this.input_name) {
            this.message_is_error = true;
            this.add_friend_message = '好友名字不能为空';
            return;
          }
          this.$http.post('/api/account/add_friend', { username: this.input_name }, { emulateJSON: false }).then(function (ret) {
            console.log(ret.body);
            if (ret.body.code == 0) {
              this.update_friends_list();
              this.message_is_error = false;
              this.add_friend_message = '添加好友成功';
            } else {
              console.log('Adding friend fails, message:', ret.body.message);
              this.message_is_error = true;
              this.add_friend_message = ret.body.message;
            }
          }, function (ret) {
            console.log('Request fails, status:', ret);
            this.message_is_error = true;
            this.add_friend_message = '添加好友失败，服务器异常';
          });
        },
      },
    });
  </script>

  {% include 'footer.html' %}

</body>

</html>